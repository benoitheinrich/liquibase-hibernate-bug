# Description

Reproduces a problem with [liquibase-maven-plugin](https://github.com/liquibase/liquibase/tree/master/liquibase-maven-plugin) using the [liquibase-hibernate5](https://github.com/liquibase/liquibase-hibernate) extension.

The issue reported is about using the `liquibase:diff` goal which always drop and recreate indexes when there is no changes to the schema.

This issue is reported here [#191](https://github.com/liquibase/liquibase-hibernate/issues/191).

**Note: if you read to the end, there is a workaround available!!**

# Setting up your DB connection

Checkout this repository and open the `pom.xml` file.

In order to run this you'll need to make sure that you setup the properties in the `pom.xml` correctly.

    <db.driver>org.mariadb.jdbc.Driver</db.driver>
    <db.url>jdbc:mysql://localhost:3306/someTest?createDatabaseIfNotExist=true</db.url>
    <db.username>root</db.username>
    <db.password/>
    <db.dialect>org.hibernate.dialect.MySQL5Dialect</db.dialect>

Be aware that to reproduce this issue you'll need to run the `liquibase:dropAll` command that will drop all tables in your DB.

Make sure you run that into a test DB, or that you have a backup first.

The default configuration uses MySQL but this doesn't only affect MySQL but also affects Oracle DB.
I suspect this might actually affect all DBMS.

# How to reproduce

Once you've setup your DB connection you can run the following command:

    mvn clean package

Be aware that this will trigger the `liquibase:dropAll` goal and it will drop all tables in your DB, so make sure you run that into a test DB, or that you have a backup first.

The command it'll generate the `liquibase-diff-changeLog.xml` file into the root of the project.
This file will contain the following content:

```$xml
<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">
    <changeSet author="benoit (generated)" id="1542806934981-1">
        <dropIndex indexName="AN_ENTITY_DATETIME" tableName="AN_ENTITY"/>
        <createIndex indexName="AN_ENTITY_DATETIME" tableName="AN_ENTITY">
            <column name="DATE_TIME"/>
        </createIndex>
    </changeSet>
</databaseChangeLog>
```

As no changes were made to the entity no changes should have been detected and generated by the `liquibase:diff` command.

That's the bug !!

# The fix

As I need this to work for my project I investigated how to make a working fix for this issue.
I ended up creating the `liquibase-fix` module which provides a new set of `liquibase.diff.output.changelog.ChangeGenerator`.
With this additional jar added to your plugin it'll nicely clear the unexpected differences reported by liquibase.

```$xml
<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd"/>
```

This also fixes a problem with column type changes not being detected due to the hibernate plugin ignoring those.
This is actually noted in the javadoc of the class `liquibase.ext.hibernate.diff.ChangedColumnChangeGenerator`:
```$java
/**
 * Hibernate and database types tend to look different even though they are not.
 * There are enough false positives that it works much better to suppress all column changes based on types.
 */
```

If you're still seeing too many false positive with this fix then I invite you to fork and update the `MyChangedColumnChangeGenerator` to either fix 
the false positive, or simply delete that class to get back to a point where every single changes will be ignored.


To install that fix you simply need to add the following dependency to you plugin dependencies:
```$xml
            <plugin>
                <groupId>org.liquibase</groupId>
                <artifactId>liquibase-maven-plugin</artifactId>
                <version>${liquibase.version}</version>
                <dependencies>
                    <dependency>
                        <groupId>com.stuff</groupId>
                        <artifactId>liquibase-fix</artifactId>
                        <version>${project.version}</version>
                    </dependency>
                    <dependency>
                        <groupId>io.vavr</groupId>
                        <artifactId>vavr</artifactId>
                        <version>${vavr.version}</version>
                    </dependency>
                    ...
                </dependencies>
            </plugin>
```

The dependency on the `vavr` is there because I'm a fan of functional programming and this allows me to build really nice apis ;)

If you don't like it you can always fork and update the code to not use that dependency.

If you don't know that library I really encourage you to have a look at it :)

Enjoy!